function onShoutSentClearNetworkCache(){network.clearCache()}$(document).bind("shoutSent",onShoutSentClearNetworkCache);seScreen.shouts_list=function(a){this.activityFeedType="public"};classExtend(seScreen.shouts_list,ScreenBase);seScreen.shouts_list.prototype.willAppear=function(){se.navigationBar.show();refreshNavigationBarButton.attachTo(se.navigationBar,{position:"prepend"});this.setTitle(M.Activity);var b=this;switchActivityFeed=function(){b.activityFeedType=b.activityFeedType=="public"?"friends":"public";var c=[];c.push({label:b.activityFeedType=="public"?M.friendsActivity:M.publicActivity,url:"javascript:switchActivityFeed();"});device.call("ui/setOptionsMenu",{items:c});b.showShouts()};if(user.authenticated("ShoutemNetwork")){var a=[];a.push({label:b.activityFeedType=="public"?M.friendsActivity:M.publicActivity,url:"javascript:switchActivityFeed();"});device.call("ui/setOptionsMenu",{items:a})}};seScreen.shouts_list.prototype.willDisappear=function(b,a){removeAdvertisement(a);setAndroidOptionsMenu()};seScreen.shouts_list.prototype.didAppear=function(b,a){showAdvertisementOnBottom(a)};seScreen.shouts_list.prototype.showShouts=function(){var d=this.jShoutsList;var c=d.find("#loadMoreContainer");var e;var f;var h=d.find("#shoutsList");h.empty();d.find("#loadMoreButton").unbind("click").click(a);if(this.activityFeedType=="public"){var i=function(k,j,l){network.getPublicTimeline(k,j,l)}}else{var i=function(k,j,l){network.getFriendsTimeline(k,j,l)}}function a(){c.hide();network.clearCache();i(undefined,e,function(j){j.shift();g(j);if(j.length>0){e=j[j.length-1].id}})}function g(j){if(j.length>0){content="";$.each(j,function(m,n){if(n.user){content+=renderEjs("shouts_list_item",{shout:n,withCommentOfLine:true,clickable:true})}});var l=h.is(":empty");h.append(content);var k=ShoutemApp.getProperties().isLoadMoreEnabled();if(j.length>=19&&k){c.show()}else{c.hide()}}}function b(){h.append('<div class="boxData"><p>'+M.noShouts+"</p></div>")}i(undefined,undefined,function(j){if(j.length>0){g(j);f=j[0].id;e=j[j.length-1].id}else{b()}})};seScreen.shouts_list.prototype.load=function(c,b){var d={};d.locationsEnabled=network.locationsEnabled;var e=$(renderEjs("shouts_list",d));this.jShoutsList=e;e.find("#checkInButton").click(function(){se.markCurrentScreen("checkInSuccess")});markCurrentScreen();this.showShouts();var a=[];c.append(e)};
var fileAttachmentImageData;seScreen.shouts_new=function(a){var b=a.params;this.authServer=b.authServer||"ShoutemNetwork"};classExtend(seScreen.shouts_new,ScreenBase);seScreen.shouts_new.prototype.authentication=function(a){this.hasAnonymousCommentFields=a.params.anonymous&&!user.authenticated(this.authServer);if(this.hasAnonymousCommentFields){return false}if(!user.authenticated(this.authServer)){return new seScreen.network_login({params:{authServer:this.authServer,onAuthenticate:reloadScreen}})}};seScreen.shouts_new.prototype.willAppear=function(b){var c=b.params;var a="";switch(c.type){case"checkin":a=M.Checkin;break;case"reshout":a=M.actionSheetReShoutButton;break;case"comment":a=M.actionSheetReplyButton;break;case"news_comment":a=M.actionSheetReplyButton;break;default:a=M.actionSheetReplyButton}se.navigationBar.show();this.setTitle(a)};seScreen.shouts_new.prototype.load=function(j,k){var b=k.params;var c,a;var e=b.authServer||"ShoutemNetwork";var g=b.providerUrl;var d=b.providerType;fileAttachmentImageData=undefined;var h=e==="ShoutemNetwork";var i=this;function f(){var n={};n.hasAnonymousCommentFields=i.hasAnonymousCommentFields;n.anonymous_contact_data_allowed=(typeof b.anonymous_contact_data_allowed=="undefined")?true:toBool(b.anonymous_contact_data_allowed);n.anonymous_data=DB.get("anonymousUser")||{};n.infoMessage=M.newShoutText;if(b.type=="news_comment"){n.infoMessage=M.createNewsCommentText}else{n.infoMessage=M.newShoutText}n.showPublishShoutOptions=b.type==="news_comment"&&b.url&&h;n.showPublishShoutOptions=false;var m=network.picturesEnabled==true&&b.type!="comment"&&b.type!="news_comment";n.htmlUploadsEnabled=false;n.nativeUploadsEnabled=m&&device.platform=="native";var l=function(r){var q=$(renderEjs("shouts_new",n));j.html(q);if(c){j.find("#placeInfo a").text(c.name);j.find("#placeInfo").show();j.find("#placeInfo li").click(function(){se.reload({params:{text:j.find("textarea").val(),type:"shout"}})})}if(r.facebook!==undefined){if(seScreen.shouts_new.facebookCheckbox===undefined){seScreen.shouts_new.facebookCheckbox=r.facebook}if(!r.facebook_connected){seScreen.shouts_new.facebookCheckbox=false}j.find("#facebookCheckbox").attr("checked",seScreen.shouts_new.facebookCheckbox);var o=function(){var u=$(this);var v=u.attr("checked");console.debug("checkFB "+v+"sharing info "+r.facebook_connected);if(v){if(!r.facebook_connected){u.attr("checked",false);if(seScreen.shouts_new.facebookCheckbox!==undefined){delete seScreen.shouts_new.facebookCheckbox}if(seScreen.shouts_new.facebookCheckbox!==undefined){delete seScreen.shouts_new.facebookCheckbox}navigateToFacebookConnect();return}}seScreen.shouts_new.facebookCheckbox=u.attr("checked")};j.find("#facebookCheckbox").unbind("click").bind("click",o);$("#facebookCheckbox").change(function(){seScreen.shouts_new.facebookCheckbox=$(this).attr("checked")});j.find("#facebookContainer").show()}else{j.find("#facebookContainer").remove()}if(r.twitter!==undefined){if(seScreen.shouts_new.twitterCheckbox===undefined){seScreen.shouts_new.twitterCheckbox=r.twitter}if(!r.twitter_connected){seScreen.shouts_new.twitterCheckbox=false}var p=function(){var u=$(this);var v=u.attr("checked");console.debug("checkTwitter "+v+"sharing info "+r.twitter_connected);if(v){if(!r.twitter_connected){u.attr("checked",false);if(seScreen.shouts_new.twitterCheckbox!==undefined){delete seScreen.shouts_new.twitterCheckbox}if(seScreen.shouts_new.twitterCheckbox!==undefined){delete seScreen.shouts_new.twitterCheckbox}navigateToTwitterConnect();return}}seScreen.shouts_new.twitterCheckbox=u.attr("checked")};j.find("#twitterCheckbox").attr("checked",seScreen.shouts_new.twitterCheckbox);j.find("#twitterCheckbox").unbind("click").bind("click",p);$("#twitterCheckbox").change(function(){seScreen.shouts_new.twitterCheckbox=$(this).attr("checked")});j.find("#twitterContainer").show()}else{j.find("#twitterContainer").remove()}j.find("#submitButton").click(function(){j.find("#shoutForm").submit()});var s=b.text||"";if(s.length>network.shoutLength){s=s.substring(0,network.shoutLength)}var t=null;if(h){j.find("#status").focus().keyup(function(){if(t){clearTimeout(t);t=null}t=setTimeout(displayCharsLeft,600)})}j.find("#status").val(s);if(h){displayCharsLeft()}if(n.htmlUploadsEnabled){j.find("#shoutForm").attr("enctype","multipart/form-data")}if(n.hasAnonymousCommentFields){j.find("#goToLogin").click(function(){navigateTo("network_login",$.extend({autoOpened:true},b))})}if(device.platform=="native"){j.find("#takePhoto").click(function(){fileAttachmentImageData=undefined;j.find("#photoPreviewContainer").hide();device.call("media/showCamera",{complete:"onPhotoTaken"})});j.find("#choosePhoto").click(function(){fileAttachmentImageData=undefined;j.find("#photoPreviewContainer").hide();device.call("media/showGallery",{complete:"onPhotoTaken",title:M.confirmChooseTitle})})}j.find("#shoutForm").submit(function(){if(h&&t){clearTimeout(t);displayCharsLeft()}if(n.hasAnonymousCommentFields&&n.anonymous_contact_data_allowed){var D=j.find("#author").val();var J=j.find("#authorEmail").val();if(!D){ui.error(getMessage("forgottenItems",M.name));return false}if(!J){ui.error(getMessage("forgottenItems",M.loginEmail));return false}}if(h){var H=j.find("#status").val().length;if(H>network.shoutLength){ui.error(M.exceededNumberOfChars);return false}}if(!c&&!fileAttachmentImageData&&H==0){if(n.hasAnonymousCommentFields){ui.error(getMessage("forgottenItems",M.actionSheetReplyButton))}else{ui.error(getMessage("forgottenItems",M.shout))}return false}var E=function(K){$(document).trigger("shoutSent",[b,K]);if(K&&K.approved===false){ui.message(M.commentSubmitted,"")}if(fileAttachmentImageData){fileAttachmentImageData=undefined}if(b.type=="checkin"){if(b.subType=="eventShout"){navigateBackToMark(1,{reload:true})}else{se.showToast(M.confirmedCheckIn);se.backToMark({mark:"checkInSuccess",reload:true})}}else{navigateBack(1,{reload:true})}};var F,x,G;if(c){F=c.geo.coordinates[0],x=c.geo.coordinates[0],G=c.id}var u=getDeviceSource();var w=b.inReplyToShoutId;var C=j.find("#facebookCheckbox").attr("checked");var I=j.find("#twitterCheckbox").attr("checked");if(n.htmlUploadsEnabled){j.find("#shoutForm").attr("action",network.getPostShoutUrl());if(w){j.find("#in_reply_to_status_id").val(w)}else{j.find("#in_reply_to_status_id").remove()}if(C){j.find("#share_on_facebook").val(true)}else{j.find("#share_on_facebook").remove()}if(I){j.find("#share_on_twitter").val(true)}else{j.find("#share_on_twitter").remove()}j.find("#source").val(getDeviceSource());if(G){j.find("#lat").val(F);j.find("#long").val(x);j.find("#shoutem_place_id").val(G)}else{j.find("#lat, #long, #shoutem_place_id").remove()}$(this).ajaxSubmit({complete:E,dataType:"json"})}else{if(b.type!=="news_comment"){var B=j.find("#status").val();if(!B){B=" "}network.postShout(B,w,F,x,u,undefined,undefined,G,C,I,undefined,undefined,fileAttachmentImageData,E)}else{var v=null;if(b.dataSource){v=shoutem.providers.newsCommentsProviderFactory.createFromDataSource(ShoutemApp.getDatasourceByRef({"$ref":b.dataSource}))}else{var A=d||(e=="ShoutemNetwork"?"ShoutemNetwork":"ShoutemApi");var z=g||e;v=shoutem.providers.newsCommentsProviderFactory.create({type:A,url:z,authServer:e})}var B=j.find("#status").val();if(!B){B=" "}var y={author:j.find("#author").val(),authorEmail:j.find("#authorEmail").val(),authorUrl:j.find("#authorUrl").val()};if(y.author||y.authorEmail){DB.set("anonymousUser",y)}v.create({articleId:b.url_id,articleUrl:b.url,text:B,author:j.find("#author").val(),authorEmail:j.find("#authorEmail").val(),authorUrl:j.find("#authorUrl").val(),createShout:j.find("#publishToFeedCheckbox").attr("checked"),success:function(){(onNewsCommentComplete||$.noop)();E()}})}}return false})};if(b.type!=="news_comment"&&b.type!=="comment"){network.getSharingInfo(user.getUserId("ShoutemNetwork"),function(o){n.showSharingOptions=o.facebook!==undefined||o.twitter!==undefined;l(o)})}else{n.showSharingOptions=false;l({})}}if(b.placeId){network.getPlace(b.placeId,function(l){c=l;f()})}else{f()}};seScreen.shouts_new.twitterCheckbox=undefined;seScreen.shouts_new.facebookCheckbox=undefined;function displayCharsLeft(b){var a=network.shoutLength-$("textarea").val().length;if(a<0){$("#charsLeft").addClass("error")}else{$("#charsLeft").removeClass("error")}$("#charsLeft").text(a)}function onPhotoTaken(b,c,a){if(b){a=a+"?"+new Date().getTime();fileAttachmentImageData=c;$("#photoPreview").attr("src",a);$("#photoPreviewContainer").show()}};
$.screen.friends_list=function(){var f=0;data.hasAMap=false;function e(g,h){network.getUserFriends(params.userId,g,h)}function d(g){var h=$("#usersList");$.each(g,function(j,k){h.append(renderEjs("users_list_item",{user:k,followButton:false}))})}function c(g){e(f+1,g)}function b(g){if(g.length>0){d(g)}c(a)}function a(g){if(g.length>0){$("#loadMoreButton").click(function(){f++;b(g)});$("#loadMoreButtonContainer").show()}else{$("#loadMoreButtonContainer").hide()}}data.screenTitle=M.friends;focusScreen(function(){var g=$("#usersList");e(f,function(h){if(h.length>0){d(h);c(a)}else{g.append('<div class="boxData"><p>'+M.noFriends+"</p></div>")}})},"users_list")};
$.screen.followers_list=function(){var f=0;data.hasAMap=false;function e(g,h){network.getUserFollowers(params.userId,g,h)}function d(g){var h=$("#usersList");$.each(g,function(j,k){h.append(renderEjs("users_list_item",{user:k,followButton:false}))})}function c(g){e(f+1,g)}function b(g){if(g.length>0){d(g)}c(a)}function a(g){if(g.length>0){$("#loadMoreButton").click(function(){f++;b(g)});$("#loadMoreButtonContainer").show()}else{$("#loadMoreButtonContainer").hide()}}data.screenTitle=M.followers;focusScreen(function(){var g=$("#usersList");e(f,function(h){if(h.length>0){d(h);c(a)}else{g.append('<div class="boxData"><p>'+M.noFollowers+"</p></div>")}})},"users_list")};
$.screen.events_details=function(){data.screenTitle=M.eventDetails;var a=null;var d=null;if(params.dataSource){var e=ShoutemApp.getDatasourceByRef({"$ref":params.dataSource});params.eventId=params.itemId;d=e.parameters.category_id;a=shoutem.providers.EventsProvider.New(e.endpointUrl)}else{var c=ShoutemApp.getFeed(ShoutemApp.FEED_TYPE.EVENT_FEEDS,params.categoryId);d=c.external_category_reference;assert(c,"feed needs to be valid");a=shoutem.providers.EventsProviderFactory.create(c)}var b=function(f){var g=renderEjs("events_list_item",{event:f,without_text:true,render_end_time:true,render_distance:false,isLink:false});$("#eventInfo").html(g);if(f.text){$("#eventTextContainer").show();$("#eventText").html(sanitizeHtml(f.text.replace(/\n/g,"<br/>")));$("#eventText").find("a").attr("target","_blank").click(openExternalLink)}if(f.place&&f.place.geo){var i=function(){var l=ShoutemApp.getModule("Places")||{};var k=15;var j=l.map_pin_small_image_url;$("img.map").attr("src",getGoogleStaticMap(f.place.geo.coordinates[0],f.place.geo.coordinates[1],getGoogleStaticMapSize(),k,j))};i();onOrientationChange(i);var h=ShoutemApp.getProperties().isCheckInEnabled();if(h){$("#checkInButton").click(function(){if(device.platform==="native"&&device.name==="iphone"){var j={name:f.name,text:getEventCheckinText(f),placeId:""+f.place.id,onComplete:"javascript:reloadScreen()"};requireAuthentication(function(){device.shoutem("eventCheckin",j)},j)}else{navigateTo(getEventShoutUrl(f))}});$("#doShout").click(function(){if(device.platform==="native"&&device.name==="iphone"){var j={name:f.name,text:getEventCheckinText(f),placeId:""+f.place.id,onComplete:"javascript:reloadScreen()"};requireAuthentication(function(){device.shoutem("eventCheckin",j)},j)}else{navigateTo(getEventShoutUrl(f))}})}else{$("#checkInButton,#doShout").hide()}network.getPlaceShouts(f.place.id,undefined,function(j){var k=$("#shoutsList");if(j.length>0){$.each(j,function(l,m){k.append(renderEjs("shouts_list_item",{shout:m,withCommentOfLine:true,clickable:false}))})}else{k.append('<div class="boxData"><p>'+M.noShouts+"</p></div>")}network.getUsersAtPlace(f.place.id,function(l){var m=$("#visitorsList");if(l.length>0){$.each(l,function(n,o){m.append(renderEjs("users_list_item",{user:o,followButton:false}))})}else{m.append('<div class="boxData"><p>'+M.noVisitors+"</p></div>")}})})}else{$(".boxTabs").remove();var h=ShoutemApp.getProperties().isCheckInEnabled();if(h){$("#placelessCheckIn").show();$("#palacelessCheckInButton").click(function(){if(device.platform==="native"&&device.name==="iphone"){var j={name:f.name,text:getEventCheckinText(f),placeId:"",onComplete:"javascript:reloadScreen()"};requireAuthentication(function(){device.shoutem("eventCheckin",j)},j)}else{navigateTo(getEventShoutUrl(f))}})}}};focusScreen(function(){a.getEvent({params:{event_id:params.eventId,category_id:d},success:b})})};
UsersListProvider=function(a){this.statusObject=$("<div></div>");this.api=new shoutem.services.ServiceClient({url:(a.shoutemApi||config.shoutemApi)+"/%s",authServer:"ShoutemNetwork",status:this.statusObject});this.api.defaultParams.nid=network.id};UsersListProvider.prototype.findNext=function(a){a=$.extend({limit:20},a);if(!a.next){return}var c=a.next;var b=this;this.api.GET("users/all",{cursor:c,count:a.limit+1,include_shoutem_fields:true},function(e){var d={data:e.users,paging:{next:null}};if(e.length>a.limit){d.paging.next=c+1;d.data=d.data.slice(0,a.limit)}b.statusObject.trigger("findNextSuccess",[d,a]);(a.success||$.noop)(d)},function(e,d){(a.error||$.noop)(e,d);b.statusObject.trigger("findNextError",[e,d])});this.find()};UsersListProvider.prototype.find=function(a){a=$.extend({limit:20},a);if(a.fromCache){return false}var c=a.page||this.page||0;var b=this;this.api.GET("users/all",{cursor:c,count:a.limit+1,include_shoutem_fields:true},function(e){var d={data:e.users,paging:{next:null}};if(d.data.length>a.limit){d.paging.next=c+1;d.data=d.data.slice(0,a.limit)}b.statusObject.trigger("findSuccess",[d,a]);(a.success||$.noop)(d)},function(e,d){(a.error||$.noop)(e,d);b.statusObject.trigger("findError",[e,d])})};seScreen.createusers_list=function(d){var e={id:"users_list_data",type:"CustomDataSource",createListProvider:function(h){return new UsersListProvider({})}};var c={id:"users_list_page",type:"ListPage",dataSource:e,items:[{type:"SimpleItem",style:"peopleItem",bindings:{id:{path:"id"},imageUrl:{path:"profile_image_url"},title:{path:"screen_name"},infoText:""},action:{type:"DelegateAction",delegate:function(h){navigateTo(getUserDetailsUrl(h.userId))},parameters:{userId:{path:"id"}}}}]};var g={id:"users_map_page",type:"MapPage",dataSource:e,items:[{id:{path:"id"},type:"NewsItem",bindings:{latitude:{path:"status.shoutem_place.geo.coordinates[0]"},longitude:{path:"status.shoutem_place.geo.coordinates[1]"},title:{path:"screen_name"}},action:{type:"DelegateAction",delegate:function(h){navigateTo(getUserDetailsUrl(h.userId))},parameters:{userId:{path:"id"}}}}]};var a={id:"users_tab_page",type:"TabbedPage",tabBarType:"Segmented",tabs:[{id:"users_list_tab",title:M.list,page:c},{id:"users_map_tab",title:M.map,page:g}]};var b=createPage(a,d);var f=b.load;b.load=function(i,h){var j=this;requireGeoPosition(function(){f.call(j,i,h)})};return b};
seScreen.users_details=function(a){this.authServer="ShoutemNetwork"};classExtend(seScreen.users_details,ScreenBase);seScreen.users_details.prototype.willAppear=function(b){var c=this.userId=user.getUserId(this.authServer);var d=b.params;this.isCurrentUser=(c==d.userId)||(!d.userId&&c);var a;if(this.isCurrentUser){a=M.Profile||M.profile}else{a=M.profile}se.navigationBar.show();this.setTitle(a)};seScreen.users_details.prototype.authentication=function(a){var b=user.getUserId(this.authServer);var c=a.params;isCurrentUser=(b==c.userId)||(!c.userId&&b);if((!c.userId||isCurrentUser)&&!user.authenticated(this.authServer)){return new seScreen.network_login({params:{authServer:this.authServer,onAuthenticate:reloadScreen}})}};seScreen.users_details.prototype.willDisappear=function(b,a){removeAdvertisement(a)};seScreen.users_details.prototype.didAppear=function(b,a){if(b.isBack){showAdvertisementOnBottom(a)}};seScreen.users_details.prototype.load=function(b,a){var f=a.params;var c=this.userId;var e={};e.isCurrentUser=this.isCurrentUser;e.showLogoutButton=e.isCurrentUser&&(false==(device.platform=="native"&&device.name=="android"));var d=ShoutemApp.getModule(ShoutemApp.MODULES.COMMUNITY)||{};e.showEditButton=e.isCurrentUser&&d.enable_profile_editing;e.hasFollowButton=d.enable_subscriptions&&c!=f.userId;e.hasSubscriptionInfo=d.enable_subscriptions;network.getUserInfo(f.userId,function(g){e.user=g;e.shout=g.status||"";b.html(renderEjs("users_details",e));showAdvertisementOnBottom(b);b.find("#shoutsLink").click(function(){navigateTo(getUserShoutsUrl(g))});if(false&&d.enable_badges){b.find("#badgesLink").click(function(){navigateTo(getBadgesUrl(g.id))})}else{b.find("#badgesLink").hide()}b.find("#friendsLink").click(function(){navigateTo(getUserFriendsUrl(g.id))});b.find("#followersLink").click(function(){navigateTo(getUserFollowersUrl(g.id))});if(e.hasFollowButton){b.find("#followButton").text(g.shoutem_followed_by?M.followingButtonTitle:M.notFollowingButtonTitle);b.find("#followButton").click(function(){toggleFriendshipStatus(g,function(){reloadScreen()})});b.find("#followButtonContainer").show()}})};
