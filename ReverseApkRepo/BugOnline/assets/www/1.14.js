function onErrorResponse(d,a){var c;if(a==="timeout"){c=M.networkTimeout}if(a==="empty"){}if(!c&&d){if(d.readyState!=4){c=M.youAreOffline}else{switch(d.status){case 401:navigateTo("network_login");return;case 403:break;case 400:try{c=JSON.parse(d.responseText).error;if(c){c=$.trim(c.replace(/Parameter name: [^ ]+/,""))}}catch(b){}break;case 404:c=M.serverIsDown;break;case 500:c=M.serverError;break;case 502:c=M.networkTimeout;break;case 0:c=M.youAreOffline;navigateBack(1);break}}}if(!c){try{console.error("UNHANDLED SERVER ERROR - STATUS "+d.status+" READYSTATE "+d.readyState+" ERROR "+a)}catch(b){console.error("UNHANDLED SERVER ERROR")}}else{ui.error(c)}}function onScreenError(a){se.activityIndicator.hide();console.debug("EXCEPTION",a)}function onScreenStartLoading(a){network.abortRequests();ui.screenLoadStart(a)}onScreenStopLoading=ui.screenLoadStop;onScreenDestroy=ui.screenDestory;function onScreenDestroy(){}function onScreenReload(){network.clearCache()}function onUserIdentityChange(){setAndroidOptionsMenu()}function onSignInFormComplete(b,a){pullUserIdentitiesFromIPhone(function(){reloadScreen()})};
(function(){var f=paramsToObject(location.hash.substring(1));var e=new shoutem.services.ServiceClient({url:(f.shoutemApi||config.shoutemApi)+"/%s",authServer:"ShoutemNetwork"});var d={shouts:{},places:{},users:{},events:{},news_likes:{},news_comments:{}};function a(g,h){$.each(h,function(j,k){d[g][k.id]=k});console.debug("NETWORK CACHE ADD "+g+" "+h.length)}function b(g,i,h){if(d[g][i]&&(h||!secondsHadPassed(config.networkCacheSecondsToLive))){console.debug("NETWORK CACHE HIT "+g+" "+i);return d[g][i]}console.debug("NETWORK CACHE MISS "+g+" "+i);return false}function c(g,h){delete d[g][h];console.debug("NETWORK CACHE CLEAR "+g+" "+h)}network=window.network={branding:{},abortRequests:function(){e.abort()},clearCache:function(){var g=ShoutemApp.getModule(ShoutemApp.MODULES.COMMUNITY);for(var h in d){if(g&&h=="shouts"){if(g.community_type!="ning"){d[h]={}}}else{d[h]={}}}e.clearCache()},loadNetwork:function(l,j,k,i){if(j){e.defaultParams.session_id=j}var g=config.apiVersion||6;var h=function(o){delete e.auth;e.defaultParams.nid=o.id;var n="69418485210";network.id=o.id;network.name=o.name;network.subdomain=o.subdomain;network.host_name=o.host_name;network.shoutLength=o.shout_length;network.languageName=o.language_name||"";network.locationsEnabled=o.location_attachments_enabled;network.eventsEnabled=o.event_attachments_enabled;network.picturesEnabled=o.picture_attachments_enabled;network.subscriptionsEnabled=o.subscriptions_enabled;if(o.facebook_api_key){var m="vab3fre8evuwU8a9abruNeqawawR74Tuy3tutraT392Huq6br3racrerudretRuy";network.facebookAppId=Tea.decrypt(o.facebook_api_key,m)}else{network.facebookAppId=n}network.isPrivate=o["private"];network.info=o;e.GET("applications/configuration.json",{include_shoutem_fields:true,nid:l,version:g,design_mode:false},function(p){network.configuration=p;e.GET("applications/configuration/new.json",{include_shoutem_fields:true,nid:l,version:g},function(q){network.appConfig=q;k()},i)},i)};e.GET("networks/show.json",{include_shoutem_fields:true,nid:l,version:g},h,i)},setSessionId:function(g){e.defaultParams.session_id=g},getLanguage:function(){return network.languageName.indexOf("Croatian")!=-1||network.languageName.indexOf("Hrvatski")!=-1?"hr":"en"},loadBranding:function(j,g){var h="iphone";var i=this;if(i.branding.themeColor){j()}e.GET("networks/branding/"+h,null,function(k){i.branding={logoUrl:k.network_logo_url||"theme/img/ShoutEm.png",themeColor:k.theme_color||"#2082C5",linkColor:k.theme_color,homeBigLogoUrl:k.home_big_logo_url,lightSublabelColor:k.light_sublabel_color||"#969696"};j()},g)},authenticateWith:function(g){e.auth=g},getSharingInfo:function(h,i,g){e.GET("users/sharing_info",{output_as_boolean:true},i,g,false)},getUserInfo:function(i,h,g){if(device.platform=="native"&&device.name=="iphone"){(g||$.noop)();return}e.GET("users/show"+(i?"/"+i:""),{include_shoutem_fields:true},h,g,false)},verifyUser:function(j,h,i,g){e.GET("users/show"+(j?"/"+j:""),{include_shoutem_fields:true},i,g,false,h)},verifyNingCredentials:function(k,h,j,g){var i={authenticated:false,};e.GET("account/verify_ning_credentials",{email:k,password:h,auto_register:true},j,g,false,i)},termsOfService:function(i,g){var h={authenticated:false,};e.GET("networks/custom_tos.json",{},i,g,false,h)},verifyNetworkCredentials:function(h,j,i){e.auth=h||null;var g={authenticated:true,authType:"basic",sessionId:h};e.GET("account/verify_credentials",{},j,i,false,g)},verifyFacebookCredentials:function(h,g,k,i){var j={};e.GET("account/verify_facebook_credentials",{session_key:h,auto_register:g},k,i,false,j)},associateFacebookAccessTokenWithCurrentUser:function(h,i,g){e.GET("account/verify_facebook_credentials",{access_token:h,nid:network.id,auto_register:true},i,g,false)},associateTwitterCredentialsWithCurrentUser:function(h,i,j,g){e.GET("account/verify_twitter_credentials",{oauth_token:h,oauth_verifier:i,auto_register:true},j,g,false)},verifyFacebookAccessToken:function(i,g,k,h){var j={};e.GET("account/verify_facebook_credentials",{access_token:i,auto_register:g,nid:network.id},k,h,false,j)},verifyTwitterCredentialsWithSessionKey:function(j,g,k,h){var i={};e.GET("account/verify_twitter_credentials",{twitter_session_key:j,auto_register:g},k,h,false,i)},verifyTwitterCredentials:function(j,k,g,l,h){var i={};e.GET("account/verify_twitter_credentials",{oauth_token:j,oauth_verifier:k,auto_register:g},l,h,false,i)},search:{shouts:function(h,i,j,g){e.GET("search",{page:i,q:h},j,g)}},getMessages:function(h,g){e.GET("direct_messages",{page:page},h,g)},getSentMessages:function(h,g){e.GET("direct_messages/sent",{page:page},h,g)},getPublicTimeline:function(g,j,i,h){e.GET("statuses/public_timeline",{include_shoutem_fields:true,since_id:g,max_id:j,fetch_replies:false},function(k){a("shouts",k);i(k)},h)},getFriendsTimeline:function(g,j,i,h){e.GET("statuses/friends_timeline",{include_shoutem_fields:true,since_id:g,max_id:j,fetch_replies:false},function(k){a("shouts",k);i(k)},h)},getMentions:function(g,j,i,h){e.GET("statuses/mentions",{include_shoutem_fields:true,since_id:g,max_id:j},function(k){a("shouts",k);i(k)},h)},getShout:function(g,j,h){var i=b("shouts",g,true);if(i){j(i,false)}else{e.GET("statuses/show",{include_shoutem_fields:true,id:g},function(k){d.shouts[k.id]=k;j(k)},h)}},getUserShouts:function(i,g,k,j,h){e.GET("statuses/user_timeline/"+i,{include_shoutem_fields:true,since_id:g,max_id:k},function(l){a("shouts",l);j(l)},h)},getUserFriends:function(h,i,j,g){e.GET("statuses/friends/"+h,{page:i,include_shoutem_fields:true},j,g)},getUserFriendsOnFacebook:function(h,g){e.GET("friends/facebook",{include_shoutem_fields:true},h,g)},getUserFriendsOnTwitter:function(h,g){e.GET("friends/twitter",{include_shoutem_fields:true},h,g)},getUserFriendsOnFoursquare:function(h,g){e.GET("friends/foursquare",{include_shoutem_fields:true},h,g)},getUserFollowers:function(h,i,j,g){e.GET("statuses/followers/"+h,{page:i,include_shoutem_fields:true},j,g)},getShoutReplies:function(g,i,h){e.GET("statuses/replies",{include_shoutem_fields:true,in_reply_to_status_id:g},i,function(k,j){if(j=="empty"){i([])}else{if(h){h(k,j)}}})},getNearbyPlaces:function(n,g,k,i,l,o,m){var j={latitude:n,longitude:g,category_ids:k,page:l};if(k){j.radius=10000000}var h=true;if(i&&i.length>2){j.name=i;h=false}e.GET("places/nearby",j,o,m,h)},getPlace:function(g,i,h){e.GET("places/show/"+g,null,i,h)},getPlaceShouts:function(g,i,j,h){e.GET("statuses/at_place/"+g,{include_shoutem_fields:true,page:i},j,h)},getUsersAtPlace:function(g,i,h){e.GET("users/at_place/"+g,null,i,h)},getNearbyUsers:function(k,i,h,j,g){e.GET("users/nearby",{latitude:k,longitude:i,page:h},j,g)},getUsers:function(h,i,g){e.GET("users/all",{cursor:h,count:20,include_shoutem_fields:true},function(j){i(j.users)},g)},getEvents:function(k,i,h,j,g){e.GET("events/at_location",{latitude:k,longitude:i,page:h},j,g)},getEvent:function(h,i,g){e.GET("events/select/"+h,null,i,g)},postMessage:function(j,i,h,g){e.POST("direct_messages/new",{user:j,text:i},h,g)},postPlace:function(m,g,h,n,k,i,j,o,l){e.POST("places/new.json?nid="+this.id,{latitude:m,longitude:g,name:h,address:n,city:k,country:i,category_id:j},o,l)},updatePlace:function(i,n,g,h,o,l,j,k,p,m){e.POST("places/update/"+i+".json?nid="+this.id,{latitude:n,longitude:g,name:h,address:o,city:l,country:j,category_id:k},p,m)},postShout:function(t,o,q,g,h,u,k,r,j,n,l,i,m,s,p){e.POST("statuses/update.json?nid="+this.id,{status:t,in_reply_to_status_id:o,lat:q,"long":g,source:h,shoutem_place_id:r,link_attachment:u,shoutem_location_name:k,share_facebook:j,share_twitter:n,share_foursquare:l,notifications_included:i,file_attachment:m},s,p)},getPostShoutUrl:function(){return config.shoutemApi+"/statuses/update.json"},postFavorite:function(h,i,g){e.POST("favorites/create/"+h+".json?nid="+this.id,{},i,g)},updateProfile:function(j,i,g,k,l,h){e.POST("account/update_profile",{name:j,url:i,location:g,description:k,},l,h)},endSession:function(g){var h=function(){if(e.defaultParams.hasOwnProperty("session_id")){delete e.defaultParams.session_id}(g||$.noop)()};e.GET("account/end_session",null,h,h,false)},signUp:function(i,k,h,j,g){e.POST("account/signup.json?nid="+this.id,{email:i,password:h,username:k},j,g)},deletePlace:function(i,h,g){e.POST("places/destroy/"+i+".json?nid="+this.id,{},h,g)},deleteShout:function(i,h,g){e.POST("statuses/destroy.json",{nid:this.id,id:i},h,g)},deleteFavorite:function(h,i,g){e.POST("favorites/destroy/"+h+".json?nid="+this.id,{},i,g)},createFriendship:function(h,i,g){e.POST("friendships/create/"+h+".json",{},i,g)},deleteFriendship:function(h,i,g){e.POST("friendships/destroy/"+h+".json",{},i,g)},getNewsLikesSummary:function(i,j,g){var h=b("news_likes",i);if(h){j(h.summary)}else{e.GET("news_likes/url_summary",{url_id:i},function(k){a("news_likes",[{id:i,summary:k}]);j(k)},g,false)}},addNewsLike:function(i,h,j,g){c("news_likes",i);e.POST("news_likes/insert",{url_id:i,url:h},j,g)},deleteNewsLike:function(i,h,j,g){c("news_likes",i);e.POST("news_likes/delete/"+h,{},j,g)},getNewsComments:function(i,j,g){var h=b("news_comments",i);if(h){j(h.comments)}else{e.GET("news_comments/collection",{url_id:i},function(k){a("news_comments",[{id:i,comments:k}]);j(k)},g,false)}},addNewsComment:function(j,i,l,g,k,h){c("news_comments",j);e.POST("news_comments/insert",{url_id:j,url:i,text:l,create_shout:g},k,h)},deleteNewsComment:function(i,h,j,g){c("news_comments",i);e.POST("news_comments/delete/"+h,{},j,g)},getNotifications:function(j,i,k,g,h){e.GET("notifications/select",{count:i,page:j,},k,g,false,null,{inBackground:h})},markNotificationsAsRead:function(h,i,g){e.GET("notifications/mark_as_read",{ids:h.join(",")},i,g,false)},countNotifications:function(h,g){e.GET("notifications/unread_count",{},h,g,false)},getPlaceCategories:function(h,g){e.GET("categories/select/root",undefined,h,g)},getPlaceCategory:function(h,i,g){this.getPlaceCategories(function(j){var l=false;function k(m){$.each(m,function(n,o){if(o.id==h){i(o);l=true;return}if(o.categories.length>0){k(o.categories)}})}k(j);if(l==false){console.error("Didn't find category "+h)(g||onErrorResponse)()}},g)},search:function(i,h,j,g){e.GET("search",{q:i,page:h},function(k){j(k.results)},g)},searchMembers:function(h,i,g){e.GET("users/search",{term:h},i,g)},getInboxMessages:function(h,i,g){e.GET("direct_messages",{page:h},i,g)},getSentMessages:function(h,i,g){e.GET("direct_messages/sent",{page:h},i,g)},sendMessage:function(i,h,j,g){e.POST("direct_messages/new",{screen_name:i,text:h},function(k){j(k)},g)},deleteDirectMessage:function(h,i,g){e.POST("direct_messages/destroy/"+h+".json?nid="+this.id,{},i,g)},}})();
var identityLoaded;function pullUserIdentitiesFromIPhone(a,b){pullFromIphoneComplete=function(f,d,c){var e=false;if(f){e={authServer:"ShoutemNetwork",authType:c,sessionId:f,userId:parseInt(d)||undefined}}if(e){user.identities.set(e)}(a||$.noop)()};device.shoutem("getUserIdentity",{apiType:"ShoutemNetwork",apiUrl:"",complete:"pullFromIphoneComplete"})}shoutem.User=function(c){var b={};var a=function(){this.set=function(d){b[d.authServer]=d;if(device.platform_name!="native_iphone"){user.save()}$(document).trigger("userLogIn",d)};this.remove=function(d){delete b[d]};this.findIdentity=function(d){return b[d]}};this.save=function(){DB.set("identities",b);onUserIdentityChange()};this.load=function(){b=DB.get("identities",b)||{}};this.authenticated=function(e){var d=user.identities.findIdentity(e);return(d&&d.sessionId)};this.getUserId=function(e){var d=this.identities.findIdentity(e);if(d){return d.userId}return false};this.authenticate=function(e){var f=shoutem.providers.authenticationProviderFactory.create({type:e.authServer});var d=this;f.authenticate({sessionId:e.sessionId,userId:e.userId,username:e.username,password:e.password,success:function(g){d.identities.set({authServer:e.authServer,userId:g.userId,sessionId:g.sessionId,authType:g.authType});d.save();(e.success||$.noop)();(e.complete||$.noop)()},error:function(h,g){d.identities.remove(e.authServer);d.save();(e.error||$.noop)(h,g);(e.complete||$.noop)()}})};this.identities=new a();this.logout=function(d){b={};this.save();network.endSession(d);$(document).trigger("userLogOut")}};var user=new shoutem.User();
