var logoHasLoaded=false;seScreen.home=function(a){};classExtend(seScreen.home,ScreenBase);seScreen.home.prototype.willAppear=function(){se.navigationBar.hide();removeAdvertisement()};seScreen.home.prototype.authentication=function(){if(network.isPrivate&&!user.authenticated("ShoutemNetwork")){return new seScreen.network_login({params:{authServer:this.authServer,onAuthenticate:reloadScreen}})}};seScreen.home.prototype.load=function(C,f){this.jAnchor=C;console.debug("Homescreen start");var h=0;var y=18;var k=20;var o=0;var g=ShoutemApp.getPage("HomePage","type");var q=network.configuration.skin.home_big_logo_hd_url;var x=getFromObjectList(network.configuration.modules,"type","HomeScreenGrid");var E={};E.bigLogoUrl=firstNonEmptyString(x.background_image_url,network.branding.homeBigLogoUrl);if(E.bigLogoUrl){E.hideHeader=true}var u=E.bigLogoUrl;logoLoaded=function(F){C.find("#loading-animation").hide();if(logoHasLoaded){$(F.target).addClass("show")}else{$(F.target).addClass("show")}logoHasLoaded=true};var t=function(){var J={width:640,height:920,aspect:640/920};var G={width:$(window).width(),height:$(window).height()};var F={width:G.width-J.width,height:G.height-J.height};if((F.width>0||F.height>0)||(F.width<0&&F.height<0)){var I=Math.abs(F.width)<Math.abs(J.aspect*F.height);if(I){J.width=G.width;J.height=J.width/J.aspect}else{J.height=G.height;J.width=J.height*J.aspect}}var H={x:-(J.width-G.width)/2,y:-(J.height-G.height)/2,width:J.width,height:J.height};return H};E.bigLogoScale=t();function A(H,G){if(H){return G}var F=[];$.each(G,function(J,I){if(I.index==-1){F.push(I)}else{F[I.index]=I}});return F}function p(I,H){var G=[];var F=A(I,H);$.each(F,function(K,J){var L;if(J!==undefined){var O=J.title||M[J.type]||"";if(J.action.type==="OpenPageAction"&&O){var N=ShoutemApp.getPageByRef(J.action.page);if((N.type==="UserEditPage"||N.type==="UserDetailsPage")&&!user.authenticated("ShoutemNetwork")){O=M.signIn}}G.push({shortcut:J,url:true,icon:J.buttonImageUrl||L||J.icon_url||"img/home/"+J.type.toLowerCase()+".png",label:shortenShorcutName(O),id:K})}else{if(config.debug){console.warn("Skipping shortcut : ",J);G.push({url:false,id:K})}}});return G}var d=1;var D=false;function w(){var F=$(window).height()-h-y;return F}function B(){var F=$(window).width();return(device.name=="android"&&F<300)?300:F}function m(J,K){var I=w()-o;var G=B();var H=Math.floor(G/(J));var F=Math.floor(I/(K));return{cols:H,rows:F}}function b(F,H,G){return Math.ceil(F.length/(H*G))}function v(S,P,V,L,O){var F=O;var I=Math.floor((B()-(L*P))/2)-2;var K=w();var U=Math.floor((K-((F)*V)-y));var H=((L)*P);var N=$("<div class='buttonPanel' style='top: "+U+"px; height:"+F*V+"px; width:"+B()+"px'></div>");C.find("#homeIcons").append(N);if(device.platform!=="native"){C.find(".home-content").css({top:(U-40)+"px",height:(F*V+40)+"px","padding-top":"40px"})}else{C.find(".home-content").css({top:(U)+"px",height:(F*V)+"px"})}C.find(".home-content").bind("pageChange",function(W,X){C.find("#homeIconSwitcher span").removeClass("selected");C.find("#homeIconSwitch"+(X+1)).addClass("selected")});var J=S.length;while(J%P!=0){S.push({url:false,id:""});J++}var Q=0;var T=1;var R;var G=0;$.each(S,function(X,Y){var Z=function(ac,ab,aa){ac.classes="se-home-link";ac.width=ab;ac.height=aa;if(typeof ac.badge==="undefined"){ac.badge=""}return renderEjs("home_link",ac)};if(T==1){Q++;R=(S.length-X)>(V*P)?V*P:S.length-X;list=$("<ul id='homeIconBoard"+Q+"' class='icon-board' style='width: "+H+"px; left: "+((Q-1)*B())+"px; '>")}var W=$(Z(Y,L,O));if(Y.shortcut){W.touchEvents({delayActive:100}).bind("fastClick click",function(){executeAction(Y.shortcut.action,{})});W.bind("click",function(){executeAction(Y.shortcut.action,{})})}list.append(W);if(T==R){C.find(".se-content-panel").append(list);T=1}else{T++}});C.find("#homeIcons ul:eq("+(d-1)+")").show()}function n(H){for(var F=1;F<=H;F++){var G=$("<span id='homeIconSwitch"+F+"' class='unselect'>&bull;</span>").data("board",F);C.find("#homeIconSwitcher").append(G)}C.find("#homeIconSwitcher span:eq("+(d-1)+")").addClass("selected")}function s(G){var F=w()}C.html(renderEjs("home",E));var x=getFromObjectList(network.configuration.modules,"type","HomeScreenGrid");var c=B();var e=Math.floor((B())/(x.column_count));var j=1.29;var l=Math.floor(e/j);var r=m(e,l);var a={rows:Math.min(x.row_count,r.rows),cols:Math.min(x.column_count,r.cols)};console.debug("Home screen found grid;");var i=function(F){F=F.data;console.debug("Got shortcuts");var J=(a.rows<x.row_count)||(a.cols<x.column_count);var H=p(J,F);var I=b(H,a.cols,a.rows);console.debug("Got links");if(I>1){C.find("#homeIconSwitcher").css("top",w()-y).show();D=true;n(I);v(H,a.cols,a.rows,e,l)}else{v(H,a.cols,a.rows,e,l)}var G=new Carousel(C.find(".home-content"));switchToIconBoard=function(L){G.moveToPage(L)};if(user.authenticated("ShoutemNetwork")){var K=[];$.each(H,function(L,N){if(N.type==="Notifications"){K.push(N)}});network.getNotifications(0,999,function(L){if(L.length===0){return}$.each(K,function(N,O){C.find("#link-"+O.id).find(".badge").show().html(L.length)})},$.noop,true)}};var z=DataSourceListFeedProvider.instance(ShoutemApp.getDatasourceByRef(g.dataSource));z.find({success:i})};
seScreen.search=function(){};classExtend(seScreen.search,ScreenBase);seScreen.search.prototype.willAppear=function(){se.navigationBar.show();this.setTitle(M.Search)};seScreen.search.prototype.load=function(k){var g;var b;function f(l){if(l.length==0){return}var m=k.find("#resultsList");$.each(l,function(n,o){m.append(renderEjs("search_item",{shout:o}))})}function d(l){b(g+1,l)}function i(l){f(l);d(e)}function e(l){if(l.length>0){k.find("#loadMoreButton").click(function(){g++;i(l)});k.find("#loadMoreButtonContainer").show()}else{k.find("#loadMoreButtonContainer").hide()}}var h;function a(n){m=function m(o,p){network.search(n,o,p)};var l=k.find("#resultsList");l.empty();g=1;$.screen.search.initialQuery=n;k.find("#loadMoreButtonContainer").hide();m(g,function(o){k.find(".searchIcon").removeClass("activity");if(o.length>0){f(o);d(e)}else{l.append('<div class="boxData"><p>'+M.noResults+"</p></div>")}})}k.append(renderEjs("search",{}));var c=null;var j=$.screen.search.initialQuery;ui.setupSearchField(j,a);k.find("#searchForm").submit(function(){return false})};$.screen.search=function(){var h;var g;function e(i){if(i.length==0){return}var j=$("#resultsList");$.each(i,function(k,l){j.append(renderEjs("search_item",{shout:l}))})}function d(i){g(h+1,i)}function c(i){e(i);d(a)}function a(i){if(i.length>0){$("#loadMoreButton").click(function(){h++;c(i)});$("#loadMoreButtonContainer").show()}else{$("#loadMoreButtonContainer").hide()}}var b;function f(k){j=function j(l,m){network.search(k,l,m)};var i=$("#resultsList");i.empty();h=1;$.screen.search.initialQuery=k;$("#loadMoreButtonContainer").hide();j(h,function(l){$(".searchIcon").removeClass("activity");if(l.length>0){e(l);d(a)}else{i.append('<div class="boxData"><p>'+M.noResults+"</p></div>")}})}focusScreen(function(){var j=null;var i=$.screen.search.initialQuery;ui.setupSearchField(i,f);$("#searchForm").submit(function(){return false})})};$.screen.search.initialQuery="";
$.screen.search_members=function(){var e;var d;function b(f){if(f.length==0){return}var g=$("#resultsList");$.each(f,function(h,j){g.append(renderEjs("users_list_item",{user:j,followButton:false}))})}var a;function c(h){g=function g(i,j){network.searchMembers(h,j)};var f=$("#resultsList");f.empty();e=1;$.screen.search_members.initialQuery=h;g(e,function(i){$(".searchIcon").removeClass("activity");if(i.length>0){b(i)}else{}})}data.screenTitle=M.SearchByMember;focusScreen(function(){var g=null;var f=$.screen.search_members.initialQuery;ui.setupSearchField(f,c);$("#searchForm").submit(function(){return false})},"search")};$.screen.search_members.initialQuery="";
$.screen.add_friends=function(){data.screenTitle=M.AddFriends;focusScreen(function(){$("#findFacebookFriendsButton").click(function(){navigateTo(getAddFriendsListUrl("facebook"))});$("#findTwitterFriendsButton").click(function(){navigateTo(getAddFriendsListUrl("twitter"))});$("#findFoursquareFriendsButton").click(function(){navigateTo(getAddFriendsListUrl("foursquare"))})})};
$.screen.add_friends_list=function(){var e;var f;var h;switch(params.source){case"facebook":var e="Facebook";f=network.getUserFriendsOnFacebook;h=navigateToFacebookConnect;break;case"twitter":var e="Twitter";f=network.getUserFriendsOnTwitter;h=navigateToTwitterConnect;break;case"foursquare":var e="Foursquare";f=network.getUserFriendsOnFoursquare;h=navigateToFoursquareConnect;break}function g(i){return i.shoutem_followed_by?M.followingButtonTitle:M.notFollowingButtonTitle}function c(i){var j=$("#resultsList");$.each(i,function(l,k){var m=$(renderEjs("users_list_item",{user:k,followButton:true,followButtonText:g(k)}));m.find("button").text(g(k)).click(function(){var n=$(this);toggleFriendshipStatus(k,function(){n.text(g(k))})});j.append(m)})}function b(){var i=getMessage("youDontHaveFriends",e,network.name);$("#resultsList").append('<div class="boxData"><p>'+i+"</p></div>")}function a(){navigateToTwitterConnect()}function d(){data.screenTitle=getMessage("siteFriends",e);f(function(i){focusScreen(function(){if(i.length==0){b();return}c(i)})},function(j,i){if(j&&j.status==403||j.status==424){h();return}onErrorResponse(j,i)})}onExternalServiceConnect(function(i){d()},function(j,i){onVerificationError(j,i);navigateTo("home")},d)};
seScreen.edit_profile=function(){};classExtend(seScreen.edit_profile,ScreenBase);seScreen.edit_profile.prototype.willAppear=function(){this.setTitle(M.editProfile);se.navigationBar.show()};seScreen.edit_profile.prototype.load=function(b,a){function c(){var f=b.find("#name").val();var e=b.find("#url").val();var d=b.find("#location").val();var g=b.find("#description").val();if(f==""){ui.error(getMessage("forgottenItems",M.name));return false}return network.updateProfile(f,e,d,g,function(){network.clearCache();history.go(-1)})}network.getUserInfo(user.getUserId("ShoutemNetwork"),function(d){var e={};e.user=d;b.html(renderEjs("edit_profile",e));b.find("#submitButton").click(c)})};
function getNotificationMessage(c){var b=c.text_format;if(b.indexOf("{*actor*}")!=-1){var a=c.actor.screen_name;b=b.replace("{*actor*}","<em>"+a+"</em>")}if(b.indexOf("{*shout*}")!=-1){var a;if(c.status&&c.status.text){a="'"+getTextExcerpt(c.status.text,120)+"'"}else{a=M.shout.toLowerCase()}b=b.replace("{*shout*}","<em>"+a+"</em>")}if(b.indexOf("{*publisher*}")!=-1){var a=c.status.user.screen_name;b=b.replace("{*publisher*}","<em>"+a+"</em>")}return b}function getNotificationUrl(a){if(a.status){return getShoutDetailsUrl(a.status.id)}else{return getUserDetailsUrl(a.actor.id)}}$.screen.notifications=function(){data.screenTitle=M.notifications;var d=20;var c=0;function b(e){if(e.length==0){return}network.markNotificationsAsRead(e)}function a(f){var h=$("#notificationsFeed");var g="";var e=[];$.each(f,function(j,k){g+=renderEjs("notifications_item",{notification:k});e.push(k.id)});h.append(g);b(e);var i=f.length==d;if(i){$("#loadMoreButtonContainer").show()}else{$("#loadMoreButtonContainer").hide()}}requireAuthentication(function(){network.getNotifications(c,d,function(e){focusScreen(function(){if(e.length===0){$("#notificationsText").html("<p>"+M.noNotifications+"</p>").show()}else{a(e)}});$("#loadMoreButton").click(function(){c++;network.getNotifications(c,d,a)})})})};
seScreen.messages_list=function(b){var c={id:"users_list_data",type:"CustomDataSource",createListProvider:function(g){return new MessagesListProvider({})}};var d={id:"users_list_data",type:"CustomDataSource",createListProvider:function(g){return new MessagesListProvider({method:"sent"})}};var e={id:"inbox_list_page",type:"ListPage",dataSource:c,items:[{type:"NewsItem",bindings:{title:{path:"sender_screen_name"},summary:{path:"text"},imageUrl:{path:"sender.profile_image_url"},infoBarType:{value:"TwoSegmentsWide"},info1Text:{converter:{type:"TimeDistanceConverter",parameters:{startTime:{path:"created_at"},prettify:true}}},info1Icon:{value:"info_time_dark.png"}},action:{type:"DelegateAction",delegate:function(g){}}}]};var f={id:"inbox_list_page",type:"ListPage",dataSource:d,items:[{type:"NewsItem",bindings:{title:{path:"recipient_screen_name"},summary:{path:"text"},imageUrl:{path:"recipient.profile_image_url"},infoBarType:{value:"TwoSegmentsWide"},info1Text:{converter:{type:"TimeDistanceConverter",parameters:{startTime:{path:"created_at"},prettify:true}}},info1Icon:{value:"info_time_dark.png"}},action:{type:"DelegateAction",delegate:function(g){}}}]};var a={id:"users_tab_page",type:"TabbedPage",tabBarType:"Segmented",tabs:[{id:"users_list_tab",title:M.messagesInboxTitle,page:e},{id:"users_map_tab",title:M.messagesSentTitle,page:f}]};seScreen.messages_list.constructor.call(this,a,b)};classExtend(seScreen.messages_list,sePages.SegmentedTabPage);seScreen.messages_list.prototype.authentication=function(a){if(!user.authenticated("ShoutemNetwork")){return new seScreen.network_login({params:{authServer:"ShoutemNetwork",onAuthenticate:function(){reloadScreen()}}})}};seScreen.messages_list.prototype.willAppear=function(b){se.navigationBar.show();this.setTitle(M.Messages);var a=new NavigationBarButton({icon:"img/icon_comment.png",onClick:function(){navigateTo(getNewMessageUrl())}});a.attachTo(se.navigationBar);this.parent.willAppear.call(this,b)};MessagesListProvider=function(a){this.statusObject=$("<div></div>");this.api=new shoutem.services.ServiceClient({url:(a.shoutemApi||config.shoutemApi)+"/%s",authServer:"ShoutemNetwork",status:this.statusObject});this.api.defaultParams.nid=network.id;this.method=a.method?"/"+a.method:""};MessagesListProvider.prototype.findNext=function(a){a=$.extend({limit:20},a);if(!a.next){return}var c=a.next;var b=this;this.api.GET("direct_messages"+this.method,{cursor:c,count:a.limit+1,include_shoutem_fields:true},function(e){var d={data:e,paging:{next:null}};if(users.length>a.limit){d.paging.next=c+1;d.data=d.data.slice(0,a.limit)}b.statusObject.trigger("findNextSuccess",[d,a]);(a.success||$.noop)(d)},function(e,d){(a.error||$.noop)(e,d);b.statusObject.trigger("findNextError",[e,d])});this.find()};MessagesListProvider.prototype.find=function(a){a=$.extend({limit:20},a);if(a.fromCache){return false}var c=a.page||this.page||0;var b=this;this.api.GET("direct_messages"+this.method,{cursor:c,count:a.limit+1,include_shoutem_fields:true},function(e){var d={data:e,paging:{next:null}};if(d.data.length>a.limit){d.paging.next=c+1;d.data=d.data.slice(0,a.limit)}b.statusObject.trigger("findSuccess",[d,a]);(a.success||$.noop)(d)},function(e,d){(a.error||$.noop)(e,d);b.statusObject.trigger("findError",[e,d])})};
seScreen.messages_new=function(){};classExtend(seScreen.messages_new,ScreenBase);seScreen.messages_new.prototype.authentication=function(a){if(!user.authenticated("ShoutemNetwork")){return new seScreen.network_login({params:{authServer:"ShoutemNetwork",onAuthenticate:function(){reloadScreen()}}})}};seScreen.messages_new.prototype.willAppear=function(a){se.navigationBar.show();this.setTitle(M.newMessage)};seScreen.messages_new.prototype.load=function(f,c){data={};var e=$(renderEjs("messages_new",data));f.append(e);var h=f.find("#messageForm");var g=e.find("#to");var a=e.find(".searchIcon");function d(){var i=$.trim(e.find("#message").val());var j=$.trim(g.val());if(j==""){ui.error(getMessage("forgottenItems",M.messagesToLabelTitle))}else{if(i==""){ui.error(getMessage("forgottenItems",M.message))}else{ui.activityIndicatorEnabled=true;network.sendMessage(j,i,function(){navigateBack(1,{reload:true})},function(l,k){if(l&&(l.status==403||l.status==400)){ui.error(M.sendingMessageFailedMessage)}else{onErrorResponse(l,k)}})}}}function b(i){return'<img src="'+getAvatarUrl(i)+'" /> <span class="content">'+i.screen_name+"</span>"}e.find("#submitButton").click(function(){h.submit()});h.submit(function(){d();return false});g.autocomplete({source:function(j,i){ui.activityIndicator="search";a.addClass("activity");network.searchMembers(j.term,function(k){a.removeClass("activity");i($.map(k,function(l){if(l.id==user.getUserId("ShoutemNetwork")){return}return{label:b(l),value:l.screen_name,}}))},$.noop)},minLength:2}).data("autocomplete")._renderItem=function(i,j){return $("<li class='user'></li>").data("item.autocomplete",j).click(function(){g.val(j.value).blur()}).append(j.label).appendTo(i)}};
seScreen.badges_list=function(a){var b=a.params;if(!b.userId&&user.getUserId("ShoutemNetwork")!=false){this.userId=user.getUserId("ShoutemNetwork")}else{this.userId=b.userId}};classExtend(seScreen.badges_list,ScreenBase);seScreen.badges_list.prototype.authentication=function(a){if(!user.authenticated("ShoutemNetwork")){return new seScreen.network_login({params:{authServer:"ShoutemNetwork",onAuthenticate:function(){reloadScreen()}}})}};seScreen.badges_list.prototype.willAppear=function(){se.navigationBar.show();refreshNavigationBarButton.attachTo(se.navigationBar,{position:"prepend"});var a;if(this.userId===user.getUserId("ShoutemNetwork")){a=M.Badges||M.badgesTitle}else{a=M.badgesTitle}this.setTitle(a)};seScreen.badges_list.prototype.load=function(c){var b=this;function a(f,d){if(f.length==0){if(d.screen_name){c.find("#badgesListLoadMessage").html("<p>"+d.screen_name+" "+M.noBadgesMessage+"</p>").show()}else{c.find("#badgesListLoadMessage").html("<p>"+M.noBadgesMessage+"</p>").show()}return}var e=c.find("#badgesList");$.each(f,function(h,g){e.append($(renderEjs("badges_list_item",{badge:g})).click(function(){navigateTo(getBadgeDetailsUrl(b.userId,h))}))})}c.append(renderEjs("badges_list",{}));network.getUserInfo(this.userId,function(d){a(d.shoutem_badges,d)})};
$.screen.badges_details=function(){network.getUserInfo(params.userId,function(a){data.badge=a.shoutem_badges[params.badgeId];data.screenTitle=M.badgeDetailsTitle;focusScreen()},function(){navigateBack(1)})};
function debugCallback(){var a="Invoked callback("+$.makeArray(arguments).join(",")+")";alert(a)}$.screen.test=function(){focusScreen(function(){function a(b,c){$("#buttons").append($("<button>").addClass("btnButton").text(b).click(c)).append("<br>")}a("getUserIdentity - shoutem network, auth required",function(){device.shoutem("getUserIdentity",{nid:network.id,apiType:"ShoutemNetwork",complete:"debugCallback",required:true})});a("getUserIdentity - shoutem network, auth not required",function(){device.shoutem("getUserIdentity",{nid:network.id,apiType:"ShoutemNetwork",complete:"debugCallback",required:false})});a("getUserIdentity - shoutem api server, auth required",function(){device.shoutem("getUserIdentity",{apiType:"ShoutemApi",apiUrl:"http://blog.shoutem.com?shoutemapi",complete:"debugCallback",required:true,})});a("getUserIdentity - shoutem api server, auth not required",function(){device.shoutem("getUserIdentity",{apiType:"ShoutemApi",apiUrl:"http://blog.shoutem.com?shoutemapi",complete:"debugCallback",required:false,})});a("showNewsCommentForm - not anonymous, with login",function(){device.shoutem("showNewsCommentForm",{onComplete:"debugCallback",onLogin:"debugCallback",anonymous:false})});a("showNewsCommentForm - anonymous, with login",function(){device.shoutem("showNewsCommentForm",{onComplete:"debugCallback",onLogin:"debugCallback",anonymous:true})});a("showNewsCommentForm -  not anonymous, without login",function(){device.shoutem("showNewsCommentForm",{onComplete:"debugCallback",anonymous:false})});a("showNewsCommentForm - anonymous, without login",function(){device.shoutem("showNewsCommentForm",{onComplete:"debugCallback",anonymous:true})})})};
