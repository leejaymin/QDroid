seScreen.network_login=function(a){this.authServer=a.params.authServer||"ShoutemNetwork";this.onAuthenticate=a.params.onAuthenticate};classExtend(seScreen.network_login,ScreenBase);seScreen.network_login.prototype.willAppear=function(){se.navigationBar.show();this.setTitle(M.login)};seScreen.network_login.prototype.load=function(h,i){var c=i.params;var f=currentScreen!="network_login";var d=this.authServer;var e=this;function g(){se.activityIndicator.hide();if(c.twRedirect||c.fbRedirect){navigateToRoot(getHomeUrl())}else{if(e.onAuthenticate){e.onAuthenticate()}else{navigateBack(1)}}}function b(){var l={};if(d=="ShoutemNetwork"){var k=ShoutemApp.getModule(ShoutemApp.MODULES.COMMUNITY);l.connectWithSection=k.enable_facebook_connect||k.enable_twitter_connect;l.registerUsersSection=k.enable_profile_editing||k.enable_ning_connect;if(k.enable_ning_connect){var j=ShoutemApp.getModule("Ning");if(j){l.signUpUrl="http://"+j.ning_network_subdomain+".ning.com/main/authorization/signUp"}}l.loginText=getMessage("loginText",network.name);l.facebookConnect=k.enable_facebook_connect;l.twitterConnect=k.enable_twitter_connect}else{l.registerUsersSection=false;l.connectWithSection=false;var n=d.split("?")[0];l.loginText=getMessage("loginText",n)}l.announceText=null;var m=$(renderEjs("network_login",l));m.find("#submit").click(function(){m.find("form").submit()});m.find("#username").focus(function(){var o=$(this).offset()});m.find("#password").focus(function(){var o=$(this).offset()});m.find("#registerLink").click(function(){if(l.signUpUrl){openExternalLink(null,l.signUpUrl)}else{navigateTo(getScreenUrl("account_new",{}))}});m.find("#fbConnectButton").bind("click",function(){return navigateToFacebookConnect(true)});m.find("#twConnectButton").bind("click",function(){return navigateToTwitterConnect(true)});if(device.name=="android"){m.find("input").height(34)}m.find("form").submit(function(){user.authenticate({authServer:d,username:m.find("#username").val(),password:m.find("#password").val(),success:g,error:function(p,o){if(p&&p.status==0){message=M.youAreOffline;ui.error(message)}else{ui.error(getMessage("userNameAndPassInvalid"))}}});return false});h.html(m)}var a=true;if(typeof(c.loginUser)!="undefined"){a=c.loginUser}console.debug("Login user: "+a);onExternalServiceConnect(c,function(j){g()},function(k,j){onVerificationError(k,j);b()},function(){b()},a)};
seScreen.account_new=function(){};classExtend(seScreen.account_new,ScreenBase);seScreen.account_new.prototype.load=function(b,a){var c=$(renderEjs("account_new",{}));b.append(c);b.find("#submit").click(function(){b.find("form").submit()});b.find("form").submit(function(){var e=b.find("#username").val(),d=b.find("#email").val();password=b.find("#password").val(),password2=b.find("#password2").val();if(d==""){ui.error(getMessage("forgottenItems","E-mail"));return false}if(e==""){ui.error(getMessage("forgottenItems",getMessage("nickname")));return false}if(password==""){ui.error(getMessage("forgottenItems",getMessage("password")));return false}if(password2==""){ui.error(getMessage("forgottenItems",getMessage("repeatPassword")));return false}if(password!=password2){ui.error(getMessage("passwordsDontMatch"));return false}termsOfServiceAccepted=function(f){if(f){network.signUp(d,e,password,function(g){var h=createAuth(e,password);user.identities.set({authServer:"ShoutemNetwork",sessionId:h,userId:g.id,authType:"basic"});user.save();network.authenticateWith(h);navigateBack(1)},function(i,h){if(i.responseText){var g=JSON.parse(i.responseText);if(g&&g.code&&M[g.code]){alert(M[g.code])}else{if(g&&g.error){alert(g.error)}else{alert(M.serverError)}}}else{alert(M.serverError)}})}};showTermsOfServiceDialog();return false})};
$.screen.attachment_details=function(){focusScreen(function(){if(params.type=="picture"){$("#picture").attr("src",params.url).css("width",ui.contentSize().width+"px").show()}})};
$.screen.places_details=function(){data.screenTitle=getPlaceDetailsTitle();focusScreen(function(){network.getPlace(params.placeId,function(b){$("#places-details-content").show();var h=ShoutemApp.getModule("Places")||{};function g(){var m=15;var l=h.map_pin_small_image_url;var n=ui.contentSize();var k=n.width;var i=Math.max(Math.round(n.height/3),150);var j=k+"x"+i;$("img.map").css({width:k+"px",height:i+"px"});$("img.map").attr("src",getGoogleStaticMap(b.geo.coordinates[0],b.geo.coordinates[1],j,m,l))}g();onOrientationChange(g);var f=ShoutemApp.getProperties().isCheckInEnabled();if(f){var e=new NavigationBarButton({title:M.checkInTitle,icon:"img/icon_comment.png",onClick:function(){navigateTo(getCheckinUrl(b))}});e.attachTo(navigationBar)}if(b){requireGeoPosition(function(){var i=currentGeoPosition.coords.longitude;var m=currentGeoPosition.coords.latitude;var n=b.geo.coordinates[1];var l=b.geo.coordinates[0];var k="http://maps.google.com/maps?saddr="+m+","+i+"&daddr="+l+","+n;navigateToDirections=function(){openExternalLink(null,k)};$("#directionsButton").attr("href",k).attr("target","_blank").click(openExternalLink).show();var j=[{label:M.home,url:"javascript:goToHomeScreen();",icon:"img/android/home.png"},{label:M.directions,url:"javascript:navigateToDirections();",icon:"img/android/directions.png"}];if(user.authenticated("ShoutemNetwork")){j.push({label:M.logout,url:"javascript:navigateTo(getLoginUrl());",icon:"img/android/logout.png"})}device.call("ui/setOptionsMenu",{items:j})})}if(h.enable_nearby_tweets){$("#twitterButton").click(function(){navigateTo(getPlacesTweetsUrl(b))})}else{$("#twitterButton").hide()}if(h.enable_view_on_yelp){$("#yelpButton").click(function(){var j=b.name;var l=b.city;var k=b.country;var i;if(k){i="http://lite.yelp.com/search?find_desc="+j+"&find_loc="+l+", "+k+"&find_submit=Search"}else{i="http://lite.yelp.com/search?find_desc="+j+"&find_loc="+l+"&find_submit=Search"}device.call("load/url",{url:i,external:true})})}else{$("#yelpButton").hide()}$("#placeInfo").html(renderEjs("places_list_item",{place:b}));if(b.creator_id==user.getUserId("ShoutemNetwork")){$("#editPlaceButton").click(function(){navigateTo(getEditPlaceUrl(b.id))}).show()}var c;var d;var a;if(b.chief){c=b.chief.screen_name;a=true;d=function(){navigateTo(getUserDetailsUrl(b.chief.id))}}else{a=false;c=M.none;d=$.noop}if(h.enable_extended_place_info){$("#placeDiscoveryInfo").append($("<li class='item'><span class='"+(a?"arrow":"")+"'></span><a>"+M.chief+" <em>"+c+"</em></a></li>").click(d)).show();if(b.creator_id){network.getUserInfo(b.creator_id,function(i){$("#placeDiscoveryInfo").append($("<li class='item'><span class='arrow'></span><a>"+M.discoveredBy+" <em>"+i.screen_name+"</em></a></li>").click(function(){navigateTo(getUserDetailsUrl(i.id))})).show()},function(){})}if(b.info){$("#placeDiscoveryInfo").append($("<li class='item'><span class='info'></span><div class='place-info'>"+M.info+" "+sanitizeHtml(b.info)+"</div></li>")).find("a").attr("target","_blank").click(openExternalLink).show()}if(b.checkin_time){$("#placeDiscoveryInfo").append($("<li class='item'><span class='arrow'></span><a>"+M.checkInTitle+": <em>"+timeDistanceInWords(b.checkin_time)+"</em></a></li>").show())}}else{if(b.info){$("#placeDiscoveryInfo").append($("<li class='item'><span class='info'></span><div class='place-info'>"+M.info+" "+sanitizeHtml(b.info)+"</div></li>")).find("a").attr("target","_blank").click(openExternalLink).show();$("#placeDiscoveryInfo").show()}}$(".placeButtons").show();network.getPlaceShouts(b.id,undefined,function(i){var j=$("#shoutsList");if(i.length>0){$.each(i,function(k,l){j.append(renderEjs("shouts_list_item",{shout:l,withCommentOfLine:true,clickable:false}))})}else{j.append('<div class="boxData"><p>'+M.noShouts+"</p></div>")}network.getUsersAtPlace(b.id,function(k){var l=$("#visitorsList");if(k.length>0){output="";$.each(k,function(m,n){output+=renderEjs("users_list_item",{user:n,followButton:false})});l.append(output)}else{l.append('<div class="boxData"><p>'+M.noVisitors+"</p></div>")}})})})})};$.screen.places_details.unload=function(){setAndroidOptionsMenu()};
$.screen.places_list=function(){var l;var f;function n(o){if(o.length==0){return}var p=$("#placesList");var q=p.is(":empty");$.each(o,function(s,r){p.append(renderEjs("places_list_item",{place:r}))})}function d(q,p){if(p.length==0){return}var r=ShoutemApp.getModule("Places")||{};var o=[];$.each(p,function(t,s){o.push({latitude:s.geo.coordinates[0],longitude:s.geo.coordinates[1]});addMarkerToGoogleMap(q,s.geo.coordinates[0],s.geo.coordinates[1],r.map_pin_small_image_url||getPlaceIconUrl(s),s.name,getPlaceDetailsUrl(s.id))});centerMap(q,o)}function j(o,p){network.getNearbyPlaces(currentGeoPosition.coords.latitude,currentGeoPosition.coords.longitude,params.categoryId,f,o,p,function(r,q){focusScreen(function(){refreshNavigationBarButton.attachTo(navigationBar,{position:"prepend"});if(!mark){markCurrentScreen()}var s=$("#placesList");if(r.status==0){s.append('<div class="boxData"><p>'+M.youAreOffline+"</p></div>")}else{s.append('<div class="boxData"><p>'+M.serverOverloaded+"</p></div>")}})})}function e(o){j(l+1,o)}function m(o){n(o);e(i)}function i(o){if(o.length>0){$("#loadMoreButton").unbind("click").click(function(){l++;m(o)});$("#loadMoreButtonContainer").show()}else{$("#loadMoreButtonContainer").hide()}}function b(){l=0;$("#placesList").empty();$("#loadMoreButtonContainer").hide();$("#addPlaceLink").hide();requireGeoPosition(function(){j(l,function(p){var o;if(p.length>0){n(p);e(i);o=M.notInList+" "+M.addPlace+" "+M.othersCanCheckIn;if(p.length>=20){k()}}else{var q=$("#placesList");q.append('<div class="boxData"><p>'+M.noPlacesMessage+"</p></div>");o=M.addPlace+" "+M.othersCanCheckIn}$("#addPlaceLink a").html(o);if(ShoutemApp.getConfiguration().enable_create_place){$("#addPlaceLink").show()}})})}var h=false;function k(){if(h==false){ui.setupSearchField("",function(o){f=o;b()},function(o){f=null;b()});$("#searchForm").show();h=true}}function a(){requireGeoPosition(function(){j(l,function(q){var o;var p=q[0];if(p){}createGoogleMap(function(r){d(r,q)},o)})})}function g(){focusScreen(function(){refreshNavigationBarButton.attachTo(navigationBar,{position:"prepend"});var p=false;$("#listTab").click(function(){if(p){return}p=true;b()});var o=false;$("#mapTab").click(function(){if(o){return}o=true;a()});setTimeout(function(){$(".tabLinks a.selected").click()},900)})}function c(){if(params.categoryId){network.getPlaceCategory(params.categoryId,function(o){data.screenTitle=o.name;g()})}else{data.screenTitle=M.NearbyPlaces;data.nextButtonTitle=M.categories;data.nextButtonIcon="img/filter.png";data.nextButtonUrl=getPlaceCategoriesUrl(undefined,false);g()}}if(network.isPrivate){requireAuthentication(c)}else{c()}};
$.screen.places_tweets=function(){var a=getServiceClient(config.searchTwitterApi||"http://search.twitter.com/%s",{appendTypeToUrl:true,timeout:config.networkTimeout,authorizationHeader:config.authorizationHeader,error:onErrorResponse,onAjaxStart:function(d){if(!d){se.activityIndicator.show()}},onAjaxComplete:function(d){if(!d){se.activityIndicator.hide()}}});function c(e){if(e.results.length>0){var d=$("#resultsList");$.each(e.results,function(f,g){d.append(renderEjs("places_tweets_item",{status:g}))})}if(e.next_page){$("#loadMoreButton").unbind("click").click(function(){b(e.next_page)});$("#loadMoreButtonContainer").show()}else{$("#loadMoreButtonContainer").hide()}}function b(d){a.GET("search.json"+d,undefined,c)}data.screenTitle=M.tweetsNearbyButtonNormal;focusScreen(function(){network.getPlace(params.placeId,function(d){var e=d.geo.coordinates[0]+","+d.geo.coordinates[1]+",1mi";a.GET("search",{geocode:e},c)})})};
$.screen.places_yelp=function(){var c=getServiceClient(config.yelpApi||"http://api.yelp.com/%s",{appendTypeToUrl:false,timeout:config.networkTimeout,authorizationHeader:config.authorizationHeader,error:onErrorResponse,onAjaxStart:function(d){if(!d){se.activityIndicator.show()}},onAjaxComplete:function(d){if(!d){se.activityIndicator.hide()}}});function b(d){if(d.length>0){var e=$("#resultsList");$.each(d,function(g,f){console.debug(f);e.append(renderEjs("places_yelp_item",{review:f}))})}else{var e=$("#resultsList");e.append('<div class="boxData"><p>'+M.noReviews+"</p></div>")}}function a(d){c.GET("search.json"+d,undefined,b)}data.screenTitle=M.yelpButtonNormal;focusScreen(function(){network.getPlace(params.placeId,function(d){c.GET("business_review_search",{term:d.name,limit:25,lat:d.geo.coordinates[0],"long":d.geo.coordinates[1],radius:10,ywsid:"YvmAJRRnhQxwrk3QnayMng"},function(e){if(e.businesses.length>0&&e.businesses[0].reviews.length>0){b(e.businesses[0].reviews)}else{b([])}})})})};
$.screen.places_new=function(){var a=function(b){if(params.placeId){network.getPlace(params.placeId,function(c){var d;b(c.name,c.address,c.city,c.country,(c.primary_category?c.primary_category.id:undefined),c.geo.coordinates[0],c.geo.coordinates[1])})}else{requireGeoPosition(function(){reverseGeocode(currentGeoPosition.coords.latitude,currentGeoPosition.coords.longitude,function(d){if(d&&d.length){var c=d[0]["formatted_address"].split(",");b("",$.trim(c[0]),$.trim(c[1]),$.trim(c[2]),undefined,currentGeoPosition.coords.latitude,currentGeoPosition.coords.longitude)}else{b("","","","",undefined,currentGeoPosition.coords.latitude,currentGeoPosition.coords.longitude)}})})}};requireAuthentication(function(){a(function(c,b,g,f,e,h,d){if(params.placeId){data.screenTitle=getEditPlaceTitle(params.placeId)}else{data.screenTitle=getEditPlaceTitle()}data.name=c;data.address=b;data.city=g;data.country=f;placeSubmit=function(){var k=$("input[name=name]").val(),j=$("input[name=address]").val(),n=$("input[name=city]").val(),m=$("input[name=country]").val(),l=$("select[name=category]").val();if(k==""){ui.error(getMessage("forgottenItems",M.placeName));return false}if(j==""){ui.error(getMessage("forgottenItems",M.placeAddress));return false}if(n==""){ui.error(getMessage("forgottenItems",M.placeCity));return false}if(m==""){ui.error(getMessage("forgottenItems",M.placeCountry));return false}var i=function(o){network.clearCache();navigateTo(getPlaceDetailsUrl(o.id))};if(params.placeId){network.updatePlace(params.placeId,h,d,k,j,n,m,l,i)}else{network.postPlace(h,d,k,j,n,m,l,i)}};focusScreen(function(){$("img.map").attr("src",getGoogleStaticMap(h,d,getGoogleStaticMapSize()));function i(){network.getPlaceCategories(function(k){var m=$("select[name=category]");var l=0;function j(n){$.each(n,function(o,p){m.append("<option value='"+p.id+"'>"+repeatString("&nbsp;&nbsp;&nbsp;&nbsp;",l)+p.name+"</option>");if(p.categories.length>0){l++;j(p.categories);l--}})}j(k);if(e){m.val(e)}$("#categorySelectContainer").show()})}i()})})})};
$.screen.url_categories=function(){data.screenTitle=M.categories;if(device.platform==="native"&&device.name==="iphone"){device.call("ui/setActionButton",{});device.call("ui/pullDownToUpdate",{enabled:false})}focusScreen(function(){var b=[];var a=ShoutemApp.getFeeds(ShoutemApp.FEED_TYPE.URL_FEEDS);$.each(a,function(e,f){var d;if(device.name==="android"&&device.platform==="native"){d="device.call('load/url', { url: '"+f.rss_url+"', external: true })"}else{d="document.location.href='"+(f.rss_url)+"'"}var c={id:f.id,url:d,name:f.name};b.push(renderEjs("url_feed_item",{feedItem:c}))});$("#newsCategories").html(b.join(""))},"news_categories")};
$.screen.places_categories=function(){var a=params.subcat=="true";function b(c){$("#placesCategories").append(renderEjs("places_categories_list",{categories:c,enableSubcategories:a}))}if(params.categoryName){data.screenTitle=params.categoryName}else{data.screenTitle=M.categories}focusScreen(function(){showAdvertisementOnBottom();if(params.categoryId){network.getPlaceCategory(params.categoryId,function(d){var c=d.categories;b(c)})}else{network.getPlaceCategories(function(c){b(c)})}})};
seScreen.shouts_details=function(){};classExtend(seScreen.shouts_details,ScreenBase);seScreen.shouts_details.prototype.willAppear=function(){se.navigationBar.show();this.setTitle(M.shout)};seScreen.shouts_details.prototype.didAppear=function(b,a){showAdvertisementOnBottom(a)};seScreen.shouts_details.prototype.willDisappear=function(b,a){setAndroidOptionsMenu();removeAdvertisement(a)};seScreen.shouts_details.prototype.load=function(b,a){var c=a.params;network.getShout(c.shoutId,function(j){var i={};var h=ShoutemApp.getModule(ShoutemApp.MODULES.COMMUNITY);i.shout=j;var f=user.getUserId("ShoutemNetwork");i.deleteButtonVisible=j.user.id==f;i.likeButtonVisible=(h.enable_likes&&(j.user.id!=f&&j.in_reply_to_status_id==null))||false;i.commentButtonVisible=j.in_reply_to_status_id==null;i.reshoutButtonVisible=network.subscriptionsEnabled;var g=$(renderEjs("shouts_details",i));b.append(g);var d=b.find("#shoutRepliesList");network.getShoutReplies(j.id,function(k){if(k.length>0){$.each(k,function(l,m){d.append(renderEjs("shouts_list_item",{shout:m,withCommentOfLine:false,clickable:false}))});d.show()}});if(j.in_reply_to_status_id){network.getShout(j.in_reply_to_status_id,function(k){g.find("#commentOfText").append(": "+k.text)})}g.find("#shoutInfo").click(function(){navigateTo(getUserDetailsUrl(j.user.id))});var e=[];if(i.reshoutButtonVisible){g.find("#reshoutButton").text(M.actionSheetReShoutButton).click(function(){navigateTo(getReshoutUrl(j.id,j.user.screen_name,j.text))});e.push({label:M.actionSheetReShoutButton,url:'javascript:navigateTo("'+getReshoutUrl(j.id,j.user.screen_name,j.text)+'");',icon:""})}if(i.commentButtonVisible){g.find("#commentButton").text(M.actionSheetReplyButton).click(function(){navigateTo(getCommentUrl(j.id,j.user.screen_name))});e.push({label:M.actionSheetReplyButton,url:'javascript:navigateTo("'+getCommentUrl(j.id,j.user.screen_name)+'");',icon:""})}deleteShout=function(){network.deleteShout(j.id,function(){network.clearCache();navigateBack(1,{reload:true})},function(l,k){if(l.status==200){network.clearCache();navigateBack(1)}})};if(i.deleteButtonVisible){g.find("#deleteButton").click(deleteShout).text(M.remove);e.push({label:M.remove,url:"javascript:deleteShout()",icon:""})}likeShout=function(){requireAuthentication(function(){var k=function(){j.favorited=j.favorited?false:true;network.clearCache();reloadScreen()};if(j.favorited){network.deleteFavorite(j.id,k)}else{network.postFavorite(j.id,k)}})};if(i.likeButtonVisible){g.find("#likeButton").click(likeShout).text(j.favorited?M.unlike:M.like);e.push({label:j.favorited?M.unlike:M.like,url:"javascript:likeShout()",icon:""});g.find("#likeButtonContainer").show()}if(e.length>0){device.call("ui/setOptionsMenu",{items:e})}},function(e,d){if(e&&e.status==404){ui.error(M.shoutDoesntExist);navigateBack(1);return}onErrorResponse(e,d)})};
